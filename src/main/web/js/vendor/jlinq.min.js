var jLinq;var jlinq;var jl;(function(){var a={command:{query:0,select:1,action:2},exp:{get_path:/\./g,escape_regex:/[\-\[\]\{\}\(\)\*\+\?\.\,\\\^\$\|\#\s]/g},type:{nothing:-1,undefined:0,string:1,number:2,array:3,regex:4,bool:5,method:6,datetime:7,object:99},library:{commands:{},types:{},addType:function(b,c){a.library.types[b]=c},extend:function(b){if(!a.util.isType(a.type.array,b)){b=[b]}a.util.each(b,function(c){a.library.commands[c.name]=c})},query:function(d,c){if(!a.util.isType(a.type.array,d)){throw"jLinq can only query arrays of objects."}d=c.clone||(c.clone==null&&jLinq.alwaysClone)?a.util.clone(d):d;var b={instance:{ignoreCase:jLinq.ignoreCase,not:false,lastCommand:null,lastField:null,records:d,removed:[],or:function(){b.startNewCommandSet()},query:{}},canRepeatCommand:function(e){return b.instance.lastCommand!=null&&e.length==(b.instance.lastCommand.method.length+1)&&a.util.isType(a.type.string,e[0])},commands:[[]],execute:function(){var e=[];var f=b.instance;a.util.each(b.instance.records,function(g){f.record=g;if(b.evaluate(f)){e.push(g)}else{b.instance.removed.push(g)}});b.instance.records=e},findValue:a.util.findValue,evaluate:function(f){for(var g=0,e=b.commands.length;g<e;g++){var h=b.commands[g];if(b.evaluateSet(h,f)){return true}}return false},evaluateSet:function(k,h){for(var g in k){if(!k.hasOwnProperty(g)){continue}var j=k[g];h.value=b.findValue(h.record,j.path);h.compare=function(e){return a.util.compare(h.value,e,h)};h.when=function(e){return a.util.when(h.value,e,h)};try{var f=j.method.apply(h,j.args);if(j.not){f=!f}if(!f){return false}}catch(i){return false}}return true},repeat:function(e){if(!b.instance.lastCommand||e==null){return}e=a.util.toArray(e);if(b.canRepeatCommand(e)){b.instance.lastField=e[0];e=a.util.select(e,null,1,null)}b.queue(b.instance.lastCommand,e)},queue:function(g,e){b.instance.lastCommand=g;var f={name:g.name,method:g.method,field:b.instance.lastField,count:g.method.length,args:e,not:b.not};if(f.args.length>g.method.length){f.field=f.args[0];f.args=a.util.remaining(f.args,1);b.instance.lastField=f.field}f.path=f.field;b.commands[b.commands.length-1].push(f);b.not=false},startNewCommandSet:function(){b.commands.push([])},setNot:function(){b.not=!b.not}};a.util.each(a.library.commands,function(g){if(g.type==a.command.query){var f=function(){b.queue(g,arguments);return b.instance.query};b.instance.query[g.name]=f;var e=a.util.operatorName(g.name);b.instance.query["or"+e]=function(){b.startNewCommandSet();return f.apply(null,arguments)};b.instance.query["orNot"+e]=function(){b.startNewCommandSet();b.setNot();return f.apply(null,arguments)};b.instance.query["and"+e]=function(){return f.apply(null,arguments)};b.instance.query["andNot"+e]=function(){b.setNot();return f.apply(null,arguments)};b.instance.query["not"+e]=function(){b.setNot();return f.apply(null,arguments)}}else{if(g.type==a.command.select){b.instance.query[g.name]=function(){b.execute();var h=b.instance;h.compare=function(j,i){return a.util.compare(j,i,h)};h.when=function(j,i){return a.util.when(j,i,h)};return g.method.apply(h,arguments)}}else{if(g.type==a.command.action){b.instance.query[g.name]=function(){var h=b.instance;h.compare=function(j,i){return a.util.compare(j,i,h)};h.when=function(j,i){return a.util.when(j,i,h)};g.method.apply(h,arguments);return b.instance.query}}}}});b.instance.query.or=function(){b.startNewCommandSet();b.repeat(arguments);return b.instance.query};b.instance.query.and=function(){b.repeat(arguments);return b.instance.query};b.instance.query.not=function(){b.setNot();b.repeat(arguments);return b.instance.query};b.instance.query.andNot=function(){b.setNot();b.repeat(arguments);return b.instance.query};b.instance.query.orNot=function(){b.startNewCommandSet();b.setNot();b.repeat(arguments);return b.instance.query};return b.instance.query}},util:{trim:function(b){b=b==null?"":b;b=b.toString();return b.replace(/^\s*|\s*$/g,"")},cloneArray:function(c){var b=[];a.util.each(c,function(d){b.push(a.util.clone(d))});return b},clone:function(c){if(a.util.isType(a.type.array,c)){return a.util.cloneArray(c)}else{if(a.util.isType(a.type.object,c)){var d={};for(var b in c){if(c.hasOwnProperty(b)){d[b]=a.util.clone(c[b])}}return d}else{return c}}},invoke:function(h,c){c=c.concat();var g=c[0];var i=a.util.findValue(h,g);c=a.util.select(c,null,1,null);g=g.replace(/\..*$/,"");var d=a.util.findValue(h,g);h=d===i?h:d;try{var b=i.apply(h,c);return b}catch(f){return null}},getPath:function(b){return a.util.toString(b).split(a.exp.get_path)},findValue:function(d,c){if(a.util.isType(a.type.array,c)){return a.util.invoke(d,c)}else{if(a.util.isType(a.type.string,c)){c=a.util.getPath(c);var b=0;while(d!=null&&b<c.length){d=d[c[b++]]}return d}else{return d}}},elementAt:function(c,b){return c&&c.length>0&&b<c.length&&b>=0?c[b]:null},regexEscape:function(b){return(b?b:"").toString().replace(a.exp.escape_regex,"\\$&")},regexMatch:function(d,c,b){if(a.util.isType(a.type.regex,d)){d=d.source}d=new RegExp(a.util.toString(d),b?"gi":"g");return a.util.toString(c).match(d)!=null},operatorName:function(b){return b.replace(/^\w/,function(c){return c.toUpperCase()})},compare:function(e,c,d){var b=a.util.when(e,c,d);return b==true?b:false},when:function(g,b,f){var d=a.util.getType(g);for(var e in b){if(!b.hasOwnProperty(e)){continue}var c=a.type[e];if(c==d){return b[e].apply(f,[g])}}if(b.other){return b.other.apply(f,[g])}return null},each:function(e,d){var b=0;for(var c in e){if(e.hasOwnProperty(c)){d(e[c],b++)}}},grab:function(d,c){var b=[];a.util.each(d,function(e){b.push(c(e))});return b},until:function(f,e){for(var d=0,c=f.length;d<c;d++){var b=e(f[d],d+1);if(b===true){return true}}return false},isType:function(b,c){return a.util.getType(c)==b},getType:function(c){if(c==null){return a.type.nothing}for(var b in a.library.types){if(a.library.types[b](c)){return b}}return a.type.object},remaining:function(d,b){var c=[];for(;b<d.length;b++){c.push(d[b])}return c},apply:function(d,c){for(var b in c){if(c.hasOwnProperty(b)){d[b]=c[b]}}return d},reorder:function(d,b,c){return a.util._performSort(d,b,c)},_performSort:function(f,g,j){var k=g.splice(0,1);if(k.length==0){return f}k=k[0];var c=a.util.isType(a.type.array,k);var b=(c?k[0]:k);var h=b.match(/^\-/);b=h?b.substr(1):b;if(h){if(c){k[0]=b}else{k=b}}var e=function(p,o){var n=a.util.findValue(p,k);var m=a.util.findValue(o,k);if(n==null&&m==null){n=0;m=0}else{if(n==null&&m!=null){n=0;m=1}else{if(n!=null&&m==null){n=1;m=0}else{if(j&&a.util.isType(a.type.string,n)&&a.util.isType(a.type.string,m)){n=n.toLowerCase();m=m.toLowerCase()}else{if(n.length&&m.length){n=n.length;m=m.length}}}}}var l=(n<m)?-1:(n>m)?1:0;return h?-l:l};f.sort(e);if(g.length>0){var i=[];var d=a.util.group(f,k,j);a.util.each(d,function(m){var n=g.slice();var l=a.util._performSort(m,n,j);i=i.concat(l)});f=i}return f},group:function(f,i,e){var b={};for(var h=0,d=f.length;h<d;h++){var c=f[h];var g=a.util.toString(a.util.findValue(c,i));g=e?g.toUpperCase():g;if(!b[g]){b[g]=[c]}else{b[g].push(c)}}return b},equals:function(d,c,b){return a.util.when(d,{string:function(){return a.util.regexMatch("^"+a.util.regexEscape(c)+"$",d,b)},other:function(){return(d==null&&c==null)||(d===c)}})},toArray:function(e){var b=[];if(e.length){for(var c=0;c<e.length;c++){b.push(e[c])}}else{for(var d in e){if(e.hasOwnProperty(d)){b.push(e[d])}}}return b},toString:function(b){return b==null?"":b.toString()},skipTake:function(e,d,c,b){c=c==null?0:c;b=b==null?e.length:b;if(c>=e.length||b==0){return[]}return a.util.select(e,d,c,c+b)},select:function(h,f,j,c){j=j==null?0:j;c=c==null?h.length:c;var e=h.slice(j,c);if(jLinq.util.isType(jLinq.type.object,f)){var g=f;f=function(l){var i={};for(var k in g){if(!g.hasOwnProperty(k)){continue}i[k]=l[k]?l[k]:g[k]}return i}}if(jLinq.util.isType(jLinq.type.method,f)){for(var d=0;d<e.length;d++){var b=e[d];e[d]=f.apply(b,[b])}}return e}}};a.library.addType(a.type.nothing,function(b){return b==null});a.library.addType(a.type.array,function(b){return b instanceof Array});a.library.addType(a.type.string,function(b){return b.substr&&b.toLowerCase});a.library.addType(a.type.number,function(b){return b.toFixed&&b.toExponential});a.library.addType(a.type.regex,function(b){return b instanceof RegExp});a.library.addType(a.type.bool,function(b){return b==true||b==false});a.library.addType(a.type.method,function(b){return b instanceof Function});a.library.addType(a.type.datetime,function(b){return b instanceof Date});a.library.extend([{name:"ignoreCase",type:a.command.action,method:function(){this.ignoreCase=true}},{name:"reverse",type:a.command.action,method:function(){this.records.reverse()}},{name:"useCase",type:a.command.action,method:function(){this.ignoreCase=false}},{name:"each",type:a.command.action,method:function(b){jLinq.util.each(this.records,function(c){b(c)})}},{name:"attach",type:a.command.action,method:function(c,b){this.when(b,{method:function(){jLinq.util.each(this.records,function(d){d[c]=b(d)})},other:function(){jLinq.util.each(this.records,function(d){d[c]=b})}})}},{name:"join",type:a.command.action,method:function(d,b,c,e){jLinq.util.each(this.records,function(f){f[b]=jLinq.from(d).equals(e,f[c]).select()})}},{name:"assign",type:a.command.action,method:function(d,b,c,e,f){jLinq.util.each(this.records,function(g){g[b]=jLinq.from(d).equals(e,g[c]).first(f)})}},{name:"sort",type:a.command.action,method:function(){var b=jLinq.util.toArray(arguments);this.records=jLinq.util.reorder(this.records,b,this.ignoreCase)}},{name:"equals",type:a.command.query,method:function(b){return jLinq.util.equals(this.value,b,this.ignoreCase)}},{name:"starts",type:a.command.query,method:function(b){return this.compare({array:function(){return jLinq.util.equals(this.value[0],b,this.ignoreCase)},other:function(){return jLinq.util.regexMatch(("^"+jLinq.util.regexEscape(b)),this.value,this.ignoreCase)}})}},{name:"ends",type:a.command.query,method:function(b){return this.compare({array:function(){return jLinq.util.equals(this.value[this.value.length-1],b,this.ignoreCase)},other:function(){return jLinq.util.regexMatch((jLinq.util.regexEscape(b)+"$"),this.value,this.ignoreCase)}})}},{name:"contains",type:a.command.query,method:function(b){return this.compare({array:function(){var c=this.ignoreCase;return jLinq.util.until(this.value,function(d){return jLinq.util.equals(d,b,c)})},other:function(){return jLinq.util.regexMatch(jLinq.util.regexEscape(b),this.value,this.ignoreCase)}})}},{name:"match",type:a.command.query,method:function(b){return this.compare({array:function(){var c=this.ignoreCase;return jLinq.util.until(this.value,function(d){return jLinq.util.regexMatch(b,d,c)})},other:function(){return jLinq.util.regexMatch(b,this.value,this.ignoreCase)}})}},{name:"type",type:a.command.query,method:function(b){return jLinq.util.isType(b,this.value)}},{name:"greater",type:a.command.query,method:function(b){return this.compare({array:function(){return this.value.length>b},string:function(){return this.value.length>b},other:function(){return this.value>b}})}},{name:"greaterEquals",type:a.command.query,method:function(b){return this.compare({array:function(){return this.value.length>=b},string:function(){return this.value.length>=b},other:function(){return this.value>=b}})}},{name:"less",type:a.command.query,method:function(b){return this.compare({array:function(){return this.value.length<b},string:function(){return this.value.length<b},other:function(){return this.value<b}})}},{name:"lessEquals",type:a.command.query,method:function(b){return this.compare({array:function(){return this.value.length<=b},string:function(){return this.value.length<=b},other:function(){return this.value<=b}})}},{name:"between",type:a.command.query,method:function(b,c){return this.compare({array:function(){return this.value.length>b&&this.value.length<c},string:function(){return this.value.length>b&&this.value.length<c},other:function(){return this.value>b&&this.value<c}})}},{name:"betweenEquals",type:a.command.query,method:function(b,c){return this.compare({array:function(){return this.value.length>=b&&this.value.length<=c},string:function(){return this.value.length>=b&&this.value.length<=c},other:function(){return this.value>=b&&this.value<=c}})}},{name:"empty",type:a.command.query,method:function(){return this.compare({array:function(){return this.value.length==0},string:function(){return jLinq.util.trim(this.value).length==0},other:function(){return this.value==null}})}},{name:"is",type:a.command.query,method:function(){return this.compare({bool:function(){return this.value===true},other:function(){return this.value!=null}})}},{name:"min",type:a.command.select,method:function(c){var b=jLinq.util.reorder(this.records,[c],this.ignoreCase);return jLinq.util.elementAt(b,0)}},{name:"max",type:a.command.select,method:function(c){var b=jLinq.util.reorder(this.records,[c],this.ignoreCase);return jLinq.util.elementAt(b,b.length-1)}},{name:"sum",type:a.command.select,method:function(c){var b;jLinq.util.each(this.records,function(d){var e=jLinq.util.findValue(d,c);b=b==null?e:(b+e)});return b}},{name:"average",type:a.command.select,method:function(c){var b;jLinq.util.each(this.records,function(d){var e=jLinq.util.findValue(d,c);b=b==null?e:(b+e)});return b/this.records.length}},{name:"skip",type:a.command.select,method:function(c,b){this.records=this.when(b,{method:function(){return jLinq.util.skipTake(this.records,b,c,null)},object:function(){return jLinq.util.skipTake(this.records,b,c,null)},other:function(){return jLinq.util.skipTake(this.records,null,c,null)}});return this.query}},{name:"take",type:a.command.select,method:function(b,c){return this.when(c,{method:function(){return jLinq.util.skipTake(this.records,c,null,b)},object:function(){return jLinq.util.skipTake(this.records,c,null,b)},other:function(){return jLinq.util.skipTake(this.records,null,null,b)}})}},{name:"skipTake",type:a.command.select,method:function(d,b,c){return this.when(c,{method:function(){return jLinq.util.skipTake(this.records,c,d,b)},object:function(){return jLinq.util.skipTake(this.records,c,d,b)},other:function(){return jLinq.util.skipTake(this.records,null,d,b)}})}},{name:"select",type:a.command.select,method:function(b){return this.when(b,{method:function(){return jLinq.util.select(this.records,b)},object:function(){return jLinq.util.select(this.records,b)},other:function(){return this.records}})}},{name:"distinct",type:a.command.select,method:function(c){var b=jLinq.util.group(this.records,c,this.ignoreCase);return jLinq.util.grab(b,function(d){return jLinq.util.findValue(d[0],c)})}},{name:"group",type:a.command.select,method:function(b){return jLinq.util.group(this.records,b,this.ignoreCase)}},{name:"define",type:a.command.select,method:function(c){var b=this.when(c,{method:function(){return jLinq.util.select(this.records,c)},object:function(){return jLinq.util.select(this.records,c)},other:function(){return this.records}});return jLinq.from(b)}},{name:"any",type:a.command.select,method:function(){return this.records.length>0}},{name:"none",type:a.command.select,method:function(){return this.records.length==0}},{name:"all",type:a.command.select,method:function(){return this.removed.length==0}},{name:"first",type:a.command.select,method:function(c){var b=jLinq.util.elementAt(this.records,0);return b==null?c:b}},{name:"last",type:a.command.select,method:function(c){var b=jLinq.util.elementAt(this.records,this.records.length-1);return b==null?c:b}},{name:"at",type:a.command.select,method:function(c,d){var b=jLinq.util.elementAt(this.records,c);return b==null?d:b}},{name:"count",type:a.command.select,method:function(){return this.records.length}},{name:"removed",type:a.command.select,method:function(b){return this.when(b,{method:function(){return jLinq.util.select(this.removed,b)},object:function(){return jLinq.util.select(this.removed,b)},other:function(){return this.removed}})}},{name:"where",type:a.command.select,method:function(e){var d=this;var c=[];jLinq.util.each(this.records,function(f){if(e.apply(d,[f])===true){c.push(f)}});var b=jLinq.from(c);if(!this.ignoreCase){b.useCase()}return b}}]);jLinq={alwaysClone:false,ignoreCase:true,command:a.command,type:a.type,extend:function(){a.library.extend.apply(null,arguments)},query:function(c,b){return library.framework.query(c,b)},from:function(b){return a.library.query(b,{clone:false})},getCommands:function(){return a.util.grab(a.library.commands,function(b){return{name:b.name,typeId:b.type,type:b.type==a.command.select?"select":b.type==a.command.query?"query":b.type==a.command.action?"action":"unknown"}})},util:{trim:a.util.trim,findValue:a.util.findValue,elementAt:a.util.elementAt,regexEscape:a.util.regexEscape,regexMatch:a.util.regexMatch,equals:a.util.equals,group:a.util.group,reorder:a.util.reorder,when:a.util.when,toArray:a.util.toArray,each:a.util.each,grab:a.util.grab,until:a.util.until,isType:a.util.isType,getType:a.util.getType,apply:a.util.apply,select:a.util.select,skipTake:a.util.skipTake}};jlinq=jLinq;jl=jLinq})();