var subscriptionsHome="";var subscriptions=[];var subscriptionsIdx=[];var filteredSubscriptions=[{l_subs_id:0,s_subs_name:0}];var selectedSubscriptionId=0;var allSubscriptionsTmpl={};var subscriptionDetailsTmpl={};var profileStreamGrpTmpl={};var jlinqQuery={};var query={sortBy:"s_subs_name",showOnlyInactive:false,showZeroSources:false,keyword:""};var onAllSubscriptionsAvailableListeners=[];var sr={};function initSubscriptions(){setupTemplates();var a=new Router().init();a.on("/view/:id",showSubscriptionDetails);sr=a.getRoute()}function setupTemplates(){susbcriptionsHome=baseUrl+"/pages/susbcriptions.jsp";allSubscriptionsTmpl=Handlebars.compile($("#all_subscriptions_tmpl").html());subscriptionDetailsTmpl=Handlebars.compile($("#subscription_details_tmpl").html());profileStreamGrpTmpl=Handlebars.compile($("#profile_stream_groups_tmpl").html())}function initialRenderAll(){query.keyword=$("#searchQuery").val();query.showOnlyInactive=$("input[name=onlyinactive]").prop("checked");runQuery(true)}function registerOnAllSubscriptionsAvailable(a){onAllSubscriptionsAvailableListeners.push(a)}function triggerOnAllSubscriptionsAvailable(){for(var a=0;a<onAllSubscriptionsAvailableListeners.length;a++){onAllSubscriptionsAvailableListeners[a](subscriptions)}}function checkFilter(){query.showOnlyInactive=$("input[name=onlyinactive]").prop("checked");query.showZeroSources=$("input[name=withoutentries]").prop("checked");runQuery(true)}function sortBy(a,b){if(b=="desc"){a="-"+a}query.sortBy=a;runQuery(true)}function filterByKeyword(){var a=$("#searchQuery");query.keyword=a.val();runQuery(true)}function runQuery(a){jlinqQuery=jlinq.from(subscriptions).sort(query.sortBy);if(query.showOnlyInactive){jlinqQuery.equals("b_gaveup",true)}if(query.showZeroSources){jlinqQuery.equals("i_total_entries",0)}if(query.keyword.length>0){jlinqQuery.contains("s_subs_name",query.keyword)}var b=jlinqQuery.select();if(a){renderAllSubscriptions(b)}if(b.length>0){showSubscriptionDetails(b[0].l_subs_id)}else{showSubscriptionDetails(0)}}function renameSubscription(c,a){for(var b=0;b<subscriptions.length;b++){if(subscriptions[b].l_subs_id==c){subscriptions[b].s_subs_name=a;break}}runQuery(true)}function saveSubscription(d,b,c){var a={};a.id=d;a.n=b;$.getJSON(baseUrl+"/api/v1/user/subscriptions/set",a,function(e){if(c){return c(e)}if(e&&e.count>0){renameSubscription(d,b)}else{console.log("error ");console.log(e)}})}function loadDefaultView(){if(subscriptions&&subscriptions.length>0){showSubscriptionDetails(subscriptions[0].l_subs_id)}}function loadSelectedView(){showSubscriptionDetails(selectedSubscriptionId)}function renderAllSubscriptions(a){$("#all_subscriptions_list").html(allSubscriptionsTmpl({subscriptions:a}));$("#count").text(a.length)}function showSubscriptionDetails(a){$("#profile_stream_groups").html("");queryData={};queryData.id=a;$.getJSON(baseUrl+"/api/v1/user/subscriptions/get",queryData,function(b){$("#subscription_details").html(subscriptionDetailsTmpl(b))});getSubscriptionStreamProfiles(a)}function apiGetAllSubscriptions(a){if(a){registerOnAllSubscriptionsAvailable(a)}$.getJSON(baseUrl+"/api/v1/user/subscriptions/list",{},function(c){subscriptions=c.entries;for(var b=0;b<subscriptions.length;b++){subscriptionsIdx.push(subscriptions[b].l_xml_id)}triggerOnAllSubscriptionsAvailable()})}function getSubscriptionStreamProfiles(a){if(!a){return}var b={};b.id=a;$.getJSON(baseUrl+"/api/v1/user/subscriptions/withprofile",b,function(c){$("#profile_stream_groups").html("");var d={};c.forEach(function(h,g,f){if(!d[h.s_stream_name]){d[h.s_stream_name]={};d[h.s_stream_name].l_stream_id=h.l_stream_id;d[h.s_stream_name].profiles=new Array()}d[h.s_stream_name].profiles.push({l_profile_id:h.l_profile_id,s_profile_name:h.s_profile_name})});for(k in d){$("#profile_stream_groups").append(profileStreamGrpTmpl({name:k,streamid:d[k].l_stream_id,subid:a,profiles:d[k].profiles}))}})}function getAllStreamSubscriptions(b,c){var a={};a.sid=b;$.getJSON(baseUrl+"/api/v1/user/subscriptions/list",a,function(d){c(d)})}function addSubscriptionToNewStream(a){}function removeFromStreamGroup(a,c){var b={};b.sui=a;b.sid=c;$.getJSON(baseUrl+"/api/v1/user/subscriptions/removefromstream",b,function(d){if(d.count>0){showSubscriptionDetails(a)}else{console.error("error ");console.error(d)}})}function removeStreamFromProfile(c,b){var a={};a.pid=c;a.sid=b}function removeFromSubscriptionsArray(a,c){for(var b=0;b<subscriptions.length;b++){if(subscriptions[b][a]==c){console.log("removed from subscriptions "+a+"="+c+"@idx "+b);subscriptions.splice(b,1);return}}}function removeSubscription(a){console.log("remove subscription "+selectedSubscriptionId);var b={};b.sid=a;$.getJSON(baseUrl+"/api/v1/user/subscriptions/remove",b,function(c){if(c.count>=0){removeFromSubscriptionsArray("l_subs_id",a);runQuery(true,true)}else{console.error("error removing subscription id "+a);console.error(c)}})};